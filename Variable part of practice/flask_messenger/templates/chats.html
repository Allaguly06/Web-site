{% extends "base.html" %}

{% block content %}
<h2>Чат с {{ recipient.username }}</h2>
<div class="row">
    <!-- Sidebar -->
    <div class="col-4">
        <h5>Пользователи</h5>
        <ul class="list-group">
            {% for u in users %}
                <li class="list-group-item">
                    <a href="{{ url_for('private_chat', recipient_id=u.id) }}">{{ u.username }}</a>
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Chat -->
    <div class="col-8">
        <div id="chat-box" class="border p-3 mb-3" style="height: 400px; overflow-y: scroll;">
            {% for message in messages %}
                <div class="d-flex {% if message.user_id == user.id %}justify-content-start{% else %}justify-content-end{% endif %}">
                    <span class="p-2 rounded bg-{% if message.user_id == user.id %}primary{% else %}success{% endif %} text-white">
                        <strong>{{ message.user.username }}:</strong> {{ message.content }}
                    </span>
                </div>
            {% endfor %}
        </div>
        <form id="chat-form">
            <div class="input-group">
                <input type="text" name="message" class="form-control" placeholder="Введите сообщение..." required>
                <button class="btn btn-primary" type="submit">Отправить</button>
            </div>
        </form>
    </div>
</div>

<script>
    var socket = io();
    var room = "{{ room }}";
    var currentUserId = {{ user.id }};

    socket.emit('join', { room: room });

    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var message = document.querySelector('input[name="message"]').value;
        if (message.trim() === "") return;
        socket.emit('send_private_message', {
            message: message,
            room: room
        });
        document.querySelector('input[name="message"]').value = '';
    });

    socket.on('receive_private_message', function(data) {
        if (data.room !== room) return;
        var chatBox = document.getElementById('chat-box');
        var newMessage = document.createElement('div');
        var isSender = currentUserId === data.user_id;
        newMessage.className = 'd-flex ' + (isSender ? 'justify-content-start' : 'justify-content-end');
        newMessage.innerHTML = `<span class="p-2 rounded bg-${isSender ? 'primary' : 'success'} text-white">
                                    <strong>${data.username}:</strong> ${data.content}
                                </span>`;
        chatBox.appendChild(newMessage);
        chatBox.scrollTop = chatBox.scrollHeight;
    });
</script>
{% endblock %}
